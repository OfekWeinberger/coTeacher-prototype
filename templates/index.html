<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ac.tive</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: { skipHtmlTags: ['noscript', 'style', 'textarea', 'script'] }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle, #ecfdf5, #f0fdf4);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
.game-2048-box {
  display: grid;
  /* 4 equal columns, 4 equal rows: */
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows:    repeat(4, 1fr);
  gap: 8px;

  /* half size and flush-left as before */
  width: 160px;
  height: 160px;
  align-self: flex-start;
  margin: 1rem 0 0 0;

  padding: 8px;
  box-sizing: border-box;
}

.game-2048-box > div {
  /* fill the whole grid‚Äêcell */
  width: 100%;
  height: 100%;

  /* center content */
  display: flex;
  align-items: center;
  justify-content: center;

  /* styling */
  background: #cdc1b4;
  font-size: 1.2rem;
  font-weight: bold;
  color: #776e65;
  border-radius: 4px;
  transition: background 0.2s;
}

    .panel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    /* 1) Make left pane wider */
    #summary-panel { width: 30%; height: 100%; }
    #video-panel   { flex: 1; height: 100%; display: flex; align-items: flex-start; justify-content: top; }
    #chat-panel    { width: 30%; height: 100%; }

    .markdown-body {
      padding: 0.5rem;
      overflow-y: auto;
    }
    .dot {
      animation: blink 1s infinite;
      font-weight: bold;
      font-size: 1.5rem;
      color: #888;
      padding: 0 0.1rem;
    }
    
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>

<body>
  <div class="flex w-full h-full">
    <div id="summary-panel" class="panel p-4">
      <h4 class="text-xl font-semibold mb-4">üìù Live Summary</h4>
      <div id="summary-text" class="markdown-body flex-1"></div>
    </div>

    <!-- Video panel -->
    <div id="video-panel" class="panel p-4 flex">
      <video id="video" controls autoplay muted class="rounded-2xl shadow-lg w-full h-auto max-h-[90vh]">
        <source src="/static/sample_video.mp4" type="video/mp4">
      </video>
      <div id="subtitle-box" class="text-center text-xl text-gray-800 mt-4 min-h-[2em] font-medium"></div>
        <div class="game-2048-box" style="display: none;"></div>
    </div>
  </div>
  <div id="chat-panel" class="panel p-4">
    <h4 class="text-xl font-semibold mb-4">üí¨ Ask Questions</h4>
    <div id="chat-log" class="markdown-body flex-1 overflow-auto"></div>
    <div class="mt-4 flex gap-2">
      <input id="user-input" type="text" placeholder="Ask a question‚Ä¶"
        class="flex-1 bg-white/80 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300" />
      <button onclick="askQuestion()"
        class="bg-emerald-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-emerald-700">
        Send
      </button>
    </div>
  </div>
  <style>
    #menu-bubble {
      position: absolute;
      top: 2rem;
      right: 2.5%;
      z-index: 50;
      width: 48px;
      height: 48px;
      background: #10b981;
      color: white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    #menu-bubble:hover {
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
      background: #059669;
    }
    #side-menu {
      position: absolute;
      top: 2rem;
      right: 2.5%;
      z-index: 60;
      width: 260px;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      padding: 1.5rem 1rem 1rem 1rem;
      display: none;
      flex-direction: column;
      gap: 1rem;
      animation: fadeInMenu 0.2s;
    }
    @keyframes fadeInMenu {
      from { opacity: 0; transform: translateY(-10px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .menu-item {
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      cursor: pointer;
      font-weight: 500;
      color: #047857;
      transition: background 0.15s;
    }
    .menu-item:hover { background: #f0fdf4; }
    .submenu {
      margin-top: 0.5rem;
      padding-left: 0.5rem;
      display: none;
      flex-direction: column;
      gap: 0.5rem;
    }
    .submenu .menu-item {
      color: #334155;
      font-weight: 400;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }
    .submenu .menu-item.selected {
      background: #d1fae5;
      color: #059669;
      font-weight: 600;
    }
    #minigames-submenu,
    #quiz-submenu {
      margin-top: 0.5rem;
      padding-left: 0.5rem;
      display: none;
      flex-direction: column;
      gap: 0.5rem;
    }
    #minigames-submenu .menu-item,
    #quiz-submenu .menu-item {
      color: #334155;
      font-weight: 400;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }
    #minigames-submenu .menu-item.selected,
    #quiz-submenu .menu-item.selected {
      background: #dbeafe;
      color: #2563eb;
      font-weight: 600;
    }
  </style>
  <div id="menu-bubble" title="Menu" onclick="toggleMenu(event)">
    <svg width="28" height="28" fill="none" viewBox="0 0 24 24">
      <circle cx="12" cy="5" r="1.5" fill="currentColor" />
      <circle cx="12" cy="12" r="1.5" fill="currentColor" />
      <circle cx="12" cy="19" r="1.5" fill="currentColor" />
    </svg>
  </div>
  <div id="side-menu">
    <div class="menu-item" onclick="toggleSubmenu('subtitles-submenu', event)">Subtitles</div>
    <div id="subtitles-submenu" class="submenu">
      <div class="menu-item" onclick="selectSubtitleLang('off', this)">Off</div>
      <div class="menu-item" onclick="selectSubtitleLang('arabic', this)">Arabic</div>
    </div>
    <div class="menu-item" onclick="toggleSubmenu('minigames-submenu', event)">Minigames</div>
    <div id="minigames-submenu" class="submenu">
    <div class="menu-item" onclick="toggle2048Game()">2048</div>
    </div>
    <div class="menu-item" onclick="toggleSubmenu('quiz-submenu', event)">Quiz</div>
    <div id="quiz-submenu" class="submenu">
      <div class="menu-item">Quiz 1</div>
      <div class="menu-item">Quiz 2</div>
    </div>
  </div>
  <script>
    // Menu open/close logic
    const menuBubble = document.getElementById('menu-bubble');
    const sideMenu = document.getElementById('side-menu');
    let menuOpen = false;
    function toggleMenu(e) {
      e.stopPropagation();
      menuOpen = !menuOpen;
      sideMenu.style.display = menuOpen ? 'flex' : 'none';
      if (!menuOpen) closeAllSubmenus();
    }
    document.addEventListener('click', function (e) {
      if (menuOpen && !sideMenu.contains(e.target) && e.target !== menuBubble) {
        sideMenu.style.display = 'none';
        menuOpen = false;
        closeAllSubmenus();
      }
    });
    function toggleSubmenu(id, e) {
      e.stopPropagation();
      const submenu = document.getElementById(id);
      submenu.style.display = submenu.style.display === 'flex' ? 'none' : 'flex';
    }
    function closeAllSubmenus() {
      document.querySelectorAll('.submenu').forEach(s => s.style.display = 'none');
    }
    let currentSubtitleLang = 'arabic'; // default
    function selectSubtitleLang(lang, el) {
      document.querySelectorAll('#subtitles-submenu .menu-item').forEach(item => item.classList.remove('selected'));
      el.classList.add('selected');
      currentSubtitleLang = lang;
      if (lang === 'arabic') {
        setupSubtitles();
      } else {
        subtitleBox.textContent = '';
        subtitles = [];
        currentIndex = -1;
      }
      sideMenu.style.display = 'none';
      menuOpen = false;
      closeAllSubmenus();
    }
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('#subtitles-submenu .menu-item').forEach(item => {
        if (item.textContent.trim().toLowerCase() === 'arabic') item.classList.add('selected');
      });
    });
  </script>
  <script>
    const SUMMARY_DATA = {{ summary_data| tojson | safe }};
    function parseTime(ts) {
      const [m, s] = ts.split(':').map(Number);
      return m * 60 + s;
    }
    function typeWriter(text, element, cb) {
      let i = 0;
      element.innerHTML = '';
      async function typeStep() {
        const current = text.slice(0, i + 1);
        element.innerHTML = marked.parse(current);
        await MathJax.typesetPromise([element]).catch(() => {});
        i++;
        if (i < text.length) {
          setTimeout(typeStep, 20); // Adjust speed as needed
        } else {
          cb();
        }
      }
      typeStep();
    }
    const container = document.getElementById('summary-text');
    let lastIndex = 0;
    function updateSummaryForTime(currentSec) {
      const toShow = [];
      SUMMARY_DATA.forEach((item, idx) => {
        if (idx < SUMMARY_DATA.length - 1) {
          if (currentSec >= parseTime(SUMMARY_DATA[idx + 1].timestamp)) {
            toShow.push(idx);
          }
        } else {
          if (currentSec >= parseTime(item.timestamp)) {
            toShow.push(idx);
          }
        }
      });
      for (let j = lastIndex; j < toShow.length; j++) {
        const idx = toShow[j];
        const item = SUMMARY_DATA[idx];
        const block = document.createElement('div');
        block.className = 'mb-4';
        container.appendChild(block);
        const raw = `${item.timestamp}  ${item.summary}`;
        typeWriter(raw, block, () => {
          block.innerHTML = marked.parse(`#### ${item.timestamp}\n\n${item.summary}`);
          MathJax.typesetPromise([block]).catch(console.error);
          container.scrollTop = container.scrollHeight;
        });
      }
      lastIndex = toShow.length;
    }
    const video = document.getElementById('video');
    video.playbackRate = 2.0; // Play at 2x speed
    video.addEventListener('loadedmetadata', () => updateSummaryForTime(0));
    video.addEventListener('timeupdate', () => updateSummaryForTime(video.currentTime));
    video.addEventListener('seeked', () => updateSummaryForTime(video.currentTime));
    const socket = io();
    const chatLog = document.getElementById('chat-log');
    let loadingMsg = null;

    socket.on('chat_response', data => {
      // Remove loading message if present
      if (loadingMsg && loadingMsg.parentNode) {
        loadingMsg.parentNode.removeChild(loadingMsg);
        loadingMsg = null;
      }

      const msg = document.createElement('div');
      msg.className = 'mb-4';
      chatLog.appendChild(msg);

      // Prepare plain text for typewriter
      const raw = `You: ${data.question}\n\nac.tive: ${data.answer}`;
      typeWriter(raw, msg, () => {
        // After typing, render markdown + math
        msg.innerHTML = marked.parse(`**You:** ${data.question}\n\n**ac.tive:** ${data.answer}`);
        MathJax.typesetPromise([msg]).catch(console.error);
        chatLog.scrollTop = chatLog.scrollHeight;
      });
      chatLog.scrollTop = chatLog.scrollHeight;
    });
    function askQuestion() {
      const q = document.getElementById('user-input').value.trim();
      if (!q) return;
      socket.emit('chat_message', { question: q, currSec: document.getElementById('video').currentTime });
      document.getElementById('user-input').value = '';

      // Add loading message
      loadingMsg = document.createElement('div');
      loadingMsg.className = 'mb-4 text-gray-500 italic';
      loadingMsg.textContent = 'ac.tive is typing...';
      chatLog.appendChild(loadingMsg);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    // Trigger askQuestion() when Enter key is pressed in the input field
    document.getElementById('user-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();  // Prevent form submission or unwanted behavior
        askQuestion();
      }
    });

  </script>
  <script>
  const videoElem   = document.getElementById('video');
  const subtitleBox = document.getElementById('subtitle-box');
  let subtitles = [], currentIndex = -1;

  // 1) Load & parse SRT cues
  async function setupSubtitles() {
    const text = await fetch('/static/subtitles_ar_binary_heaps_plain_delayed.srt')
                      .then(r => r.text());
    // split on blank lines, handling CRLF too
    const blocks = text.trim().split(/\r?\n\r?\n/);
    subtitles = blocks.map(block => {
      const [ , times, ...lines ] = block.split(/\r?\n/);
      const [start, end] = times.split(' --> ').map(t => {
        const [h,m,rest] = t.split(':'), [s,ms] = rest.split(',');
        return +h*3600 + +m*60 + +s + +ms/1000;
      });
      return { start, end, content: lines.join(' ') };
    });
  }

  // 2) Wait for load then wire up the timeupdate listener
  setupSubtitles().then(() => {
    videoElem.addEventListener('timeupdate', () => {
      const t = videoElem.currentTime;
      const idx = subtitles.findIndex(c => t >= c.start && t <= c.end);
      if (idx !== currentIndex) {
        currentIndex = idx;
        subtitleBox.textContent = idx >= 0 ? subtitles[idx].content : '';
      }
    });
  });
</script>
<script>
function open2048Game() {
  const gridDisplay = document.querySelector(".game-2048-box");
  gridDisplay.style.display = "grid";
  const width = 4;
  let squares = [];
  let score = 0;

  // 1. Create / reset board
  function createBoard() {
    squares = [];
    gridDisplay.innerHTML = "";
    for (let i = 0; i < width * width; i++) {
      const cell = document.createElement("div");
      cell.textContent = "";
      squares.push(cell);
      gridDisplay.appendChild(cell);
    }
    addRandomTile();
    addRandomTile();
    updateView();
  }

  // 2. Add a new ‚Äú2‚Äù on any empty cell
  function addRandomTile() {
    const emptyIndices = squares
      .map((cell, i) => cell.textContent === "" ? i : -1)
      .filter(i => i !== -1);
    if (!emptyIndices.length) return;
    const rnd = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
    squares[rnd].textContent = "2";
  }

  // 3. Helpers for sliding & merging
  function getVals(cells) {
    return cells.map(c => c.textContent === "" ? 0 : +c.textContent);
  }
  function slide(arr) {
    const nonZero = arr.filter(n => n !== 0);
    return nonZero.concat(Array(arr.length - nonZero.length).fill(0));
  }
  function merge(arr) {
    for (let i = 0; i < arr.length - 1; i++) {
      if (arr[i] !== 0 && arr[i] === arr[i + 1]) {
        arr[i] *= 2;
        arr[i + 1] = 0;
        score += arr[i];
      }
    }
    return arr;
  }

  // 4. Move functions
  function moveLeft() {
    for (let r = 0; r < width; r++) {
      const row = squares.slice(r * width, r * width + width);
      let v = slide(getVals(row));
      v = merge(v);
      v = slide(v);
      row.forEach((cell, i) => cell.textContent = v[i] || "");
    }
  }

  function moveRight() {
    for (let r = 0; r < width; r++) {
      const row = squares.slice(r * width, r * width + width).reverse();
      let v = slide(getVals(row));
      v = merge(v);
      v = slide(v);
      v.reverse();
      row.reverse().forEach((cell, i) => cell.textContent = v[i] || "");
    }
  }

  function moveUp() {
    for (let c = 0; c < width; c++) {
      const col = [0,1,2,3].map(i => squares[c + width * i]);
      let v = slide(getVals(col));
      v = merge(v);
      v = slide(v);
      col.forEach((cell, i) => cell.textContent = v[i] || "");
    }
  }

  function moveDown() {
    for (let c = 0; c < width; c++) {
      const col = [3,2,1,0].map(i => squares[c + width * i]);
      let v = slide(getVals(col));
      v = merge(v);
      v = slide(v);
      v.reverse();
      [0,1,2,3].forEach((i, idx) => {
        squares[c + width * i].textContent = v[idx] || "";
      });
    }
  }

  // 5. Update visuals
  function updateView() {
    squares.forEach(cell => {
      const v = cell.textContent || "";
      cell.textContent = v;
      switch (v) {
        case "2":    cell.style.background = "#eee4da"; break;
        case "4":    cell.style.background = "#ede0c8"; break;
        case "8":    cell.style.background = "#f2b179"; break;
        case "16":   cell.style.background = "#ffcea4"; break;
        case "32":   cell.style.background = "#e8c064"; break;
        case "64":   cell.style.background = "#ffab6e"; break;
        case "128":  cell.style.background = "#fd9982"; break;
        case "256":  cell.style.background = "#ead79c"; break;
        case "512":  cell.style.background = "#76daff"; break;
        case "1024": cell.style.background = "#beeaa5"; break;
        case "2048": cell.style.background = "#d7d4f0"; break;
        default:     cell.style.background = "#cdc1b4";
      }
    });
  }

  // 6. Game-over check
  function isGameOver() {
    if (squares.some(c => c.textContent === "")) return false;
    for (let i = 0; i < squares.length; i++) {
      const r = Math.floor(i / width), c = i % width;
      const here = squares[i].textContent;
      if ((c < width - 1 && squares[i + 1].textContent === here) ||
          (r < width - 1 && squares[i + width].textContent === here)) {
        return false;
      }
    }
    return true;
  }
  function endGame() {
    document.removeEventListener("keydown", handleKey);
    setTimeout(() => alert("Game over! Score: " + score), 10);
  }

  // 7. Key handler
  function handleKey(e) {
    const before = squares.map(c => c.textContent);
    if      (e.key === "ArrowLeft")  moveLeft();
    else if (e.key === "ArrowRight") moveRight();
    else if (e.key === "ArrowUp")    moveUp();
    else if (e.key === "ArrowDown")  moveDown();
    else return;

    const after = squares.map(c => c.textContent);
    if (before.join() !== after.join()) {
      addRandomTile();
      updateView();
      if (isGameOver()) endGame();
    }
  }

  // Initialize
  createBoard();
  document.removeEventListener("keydown", handleKey);
  document.addEventListener("keydown", handleKey);
}
</script>
<script>
// must come after open2048Game()
function toggle2048Game() {
  const grid = document.querySelector('.game-2048-box');
  if (grid.style.display === 'grid') {
    // if it‚Äôs visible, hide it
    grid.style.display = 'none';
    document.removeEventListener('keydown', handleKey);
  } else {
    // if hidden, re-open/reset
    open2048Game();
  }
}
</script>
</body>
</html>